<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reflex ORB - Aim Trainer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap');

        body {
            font-family: 'Outfit', sans-serif;
            background-color: #0f172a; /* Slate 900 */
            color: #f8fafc;
            overflow: hidden; /* Prevent scrolling during play */
            touch-action: manipulation; /* Improve touch response */
        }

        /* Custom Animations */
        @keyframes popIn {
            0% { transform: scale(0); opacity: 0; }
            60% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }

        @keyframes shrinkFade {
            0% { transform: scale(1); opacity: 1; }
            100% { transform: scale(0); opacity: 0; }
        }

        .orb {
            position: absolute;
            border-radius: 50%;
            cursor: crosshair;
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
            box-shadow: 0 0 15px 2px rgba(249, 115, 22, 0.6);
            z-index: 10;
        }

        .orb.dying {
            animation: shrinkFade 0.2s ease-in forwards;
            pointer-events: none;
        }

        /* Glassmorphism Panel */
        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Game Container Cursor */
        #game-area {
            cursor: crosshair;
        }
        
        /* Hide scrollbars */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1e293b; 
        }
        ::-webkit-scrollbar-thumb {
            background: #475569; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #64748b; 
        }

        .hidden-view {
            display: none !important;
        }
    </style>
</head>
<body class="h-screen w-screen flex items-center justify-center relative">

    <!-- AUDIO SYSTEM (Hidden) -->
    <!-- We will generate sound via JS AudioContext to avoid external assets -->

    <!-- ================= VIEW: LOGIN ================= -->
    <div id="view-login" class="w-full max-w-md p-8 rounded-2xl glass-panel shadow-2xl text-center z-20">
        <div class="mb-6">
            <div class="w-20 h-20 bg-orange-500 rounded-full mx-auto flex items-center justify-center shadow-lg shadow-orange-500/50 mb-4">
                <i class="fas fa-bullseye text-3xl text-white"></i>
            </div>
            <h1 class="text-4xl font-extrabold tracking-tight text-white">Reflex<span class="text-orange-500">ORB</span></h1>
            <p class="text-slate-400 mt-2">Precision Aim Trainer</p>
        </div>

        <form id="login-form" class="space-y-4">
            <div class="text-left">
                <label class="block text-sm font-medium text-slate-300 mb-1">Username</label>
                <input type="text" id="username-input" 
                    class="w-full px-4 py-3 bg-slate-800 border border-slate-600 rounded-xl focus:ring-2 focus:ring-orange-500 focus:border-transparent outline-none transition text-white placeholder-slate-500"
                    placeholder="Enter alphanumeric username" maxlength="15" autocomplete="off">
                <p id="login-error" class="text-red-400 text-xs mt-2 hidden"></p>
            </div>
            <button type="submit" 
                class="w-full bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-4 rounded-xl transition duration-200 shadow-lg shadow-orange-500/30 transform hover:scale-[1.02]">
                Start Playing
            </button>
        </form>
    </div>

    <!-- ================= VIEW: DASHBOARD ================= -->
    <div id="view-dashboard" class="hidden-view w-full max-w-4xl h-[90vh] flex flex-col md:flex-row gap-6 p-4">
        
        <!-- Sidebar: Profile & Stats -->
        <div class="w-full md:w-1/3 glass-panel rounded-2xl p-6 flex flex-col">
            <div class="flex items-center gap-4 mb-6 border-b border-slate-700 pb-4">
                <div class="w-12 h-12 bg-gradient-to-br from-orange-400 to-red-500 rounded-full flex items-center justify-center text-white font-bold text-xl">
                    <span id="profile-initial">?</span>
                </div>
                <div>
                    <h2 id="profile-name" class="font-bold text-xl truncate">Player</h2>
                    <button id="logout-btn" class="text-xs text-slate-400 hover:text-white underline">Log Out</button>
                </div>
            </div>

            <div class="space-y-4 flex-grow overflow-y-auto">
                <h3 class="text-sm uppercase tracking-wider text-slate-500 font-bold">Lifetime Stats</h3>
                
                <div class="bg-slate-800/50 p-4 rounded-xl">
                    <div class="text-slate-400 text-xs">Accuracy</div>
                    <div class="text-2xl font-bold text-white"><span id="stat-accuracy">0</span>%</div>
                    <div class="w-full bg-slate-700 h-1.5 mt-2 rounded-full overflow-hidden">
                        <div id="stat-accuracy-bar" class="bg-green-400 h-full" style="width: 0%"></div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div class="bg-slate-800/50 p-3 rounded-xl">
                        <div class="text-slate-400 text-xs">Hits</div>
                        <div id="stat-hits" class="text-xl font-bold text-orange-400">0</div>
                    </div>
                    <div class="bg-slate-800/50 p-3 rounded-xl">
                        <div class="text-slate-400 text-xs">Misses</div>
                        <div id="stat-misses" class="text-xl font-bold text-red-400">0</div>
                    </div>
                </div>

                <div class="bg-slate-800/50 p-4 rounded-xl">
                    <div class="text-slate-400 text-xs">Avg Reaction Time</div>
                    <div class="text-2xl font-bold text-white"><span id="stat-reaction">0</span> <span class="text-sm font-normal text-slate-500">ms</span></div>
                </div>
            </div>
        </div>

        <!-- Main Content: Game Modes & Leaderboard -->
        <div class="w-full md:w-2/3 flex flex-col gap-6">
            
            <!-- Mode Selection -->
            <div class="glass-panel rounded-2xl p-6">
                <h3 class="text-xl font-bold mb-4 flex items-center gap-2">
                    <i class="fas fa-gamepad text-orange-500"></i> Select Mode
                </h3>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <button onclick="game.init('free')" class="group relative bg-slate-800 hover:bg-slate-700 p-4 rounded-xl transition text-left border border-slate-700 hover:border-orange-500/50">
                        <div class="absolute top-3 right-3 text-slate-600 group-hover:text-orange-500"><i class="fas fa-infinity"></i></div>
                        <div class="font-bold text-lg mb-1">Free Play</div>
                        <div class="text-xs text-slate-400">No time limit. Just practice.</div>
                    </button>

                    <button onclick="game.init(10)" class="group relative bg-slate-800 hover:bg-slate-700 p-4 rounded-xl transition text-left border border-slate-700 hover:border-orange-500/50">
                        <div class="absolute top-3 right-3 text-slate-600 group-hover:text-orange-500"><i class="fas fa-stopwatch"></i></div>
                        <div class="font-bold text-lg mb-1">10 Seconds</div>
                        <div class="text-xs text-slate-400">Sprint mode. Speed is key.</div>
                    </button>

                    <button onclick="game.init(30)" class="group relative bg-slate-800 hover:bg-slate-700 p-4 rounded-xl transition text-left border border-slate-700 hover:border-orange-500/50">
                        <div class="absolute top-3 right-3 text-slate-600 group-hover:text-orange-500"><i class="fas fa-hourglass-half"></i></div>
                        <div class="font-bold text-lg mb-1">30 Seconds</div>
                        <div class="text-xs text-slate-400">Endurance test. Consistency.</div>
                    </button>
                </div>
            </div>

            <!-- Leaderboard -->
            <div class="glass-panel rounded-2xl p-6 flex-grow flex flex-col min-h-0">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold flex items-center gap-2">
                        <i class="fas fa-trophy text-yellow-400"></i> Leaderboard
                    </h3>
                    <div class="flex bg-slate-800 rounded-lg p-1 text-xs">
                        <button onclick="ui.renderLeaderboard('score')" id="lb-tab-score" class="px-3 py-1 rounded bg-slate-600 text-white">Top Score</button>
                        <button onclick="ui.renderLeaderboard('accuracy')" id="lb-tab-accuracy" class="px-3 py-1 rounded text-slate-400 hover:text-white">Accuracy</button>
                    </div>
                </div>
                
                <div class="overflow-y-auto pr-2 custom-scrollbar flex-grow">
                    <table class="w-full text-left border-collapse">
                        <thead class="text-slate-500 text-xs uppercase sticky top-0 bg-slate-900/90 backdrop-blur-sm z-10">
                            <tr>
                                <th class="pb-3 pl-2">Rank</th>
                                <th class="pb-3">Player</th>
                                <th class="pb-3 text-right">Hits</th>
                                <th class="pb-3 text-right pr-2">Acc %</th>
                            </tr>
                        </thead>
                        <tbody id="leaderboard-body" class="text-sm">
                            <!-- JS fills this -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- ================= VIEW: GAMEPLAY ================= -->
    <div id="view-game" class="hidden-view fixed inset-0 z-50 bg-slate-900 select-none">
        
        <!-- Game HUD -->
        <div class="absolute top-0 left-0 w-full p-4 flex justify-between items-start pointer-events-none z-20">
            <div class="bg-slate-900/80 backdrop-blur rounded-lg p-3 border border-slate-700">
                <div class="text-xs text-slate-400 uppercase">Score</div>
                <div id="hud-score" class="text-3xl font-bold text-white font-mono">0</div>
            </div>

            <div class="flex flex-col items-center">
                <div id="hud-timer-container" class="bg-slate-900/80 backdrop-blur rounded-full px-6 py-2 border border-slate-700 mb-2">
                    <div id="hud-timer" class="text-2xl font-bold text-orange-500 font-mono">--:--</div>
                </div>
                <div class="text-xs font-mono text-slate-500">MODE: <span id="hud-mode">FREE</span></div>
            </div>

            <div class="bg-slate-900/80 backdrop-blur rounded-lg p-3 border border-slate-700 text-right">
                <div class="text-xs text-slate-400 uppercase">Accuracy</div>
                <div class="text-3xl font-bold text-white font-mono"><span id="hud-accuracy">100</span>%</div>
            </div>
        </div>

        <!-- Exit Button -->
        <button onclick="game.stop(true)" class="absolute bottom-6 right-6 z-30 bg-red-500/20 hover:bg-red-500 text-red-500 hover:text-white p-3 rounded-full transition border border-red-500/50">
            <i class="fas fa-times"></i>
        </button>

        <!-- Game Area (Clickable) -->
        <div id="game-area" class="w-full h-full relative overflow-hidden">
            <!-- Balls spawn here -->
        </div>

        <!-- Game Over Modal -->
        <div id="modal-gameover" class="hidden absolute inset-0 bg-black/80 z-40 flex items-center justify-center backdrop-blur-sm">
            <div class="bg-slate-800 p-8 rounded-2xl max-w-sm w-full text-center border border-slate-600 shadow-2xl transform transition-all scale-100">
                <h2 class="text-3xl font-bold text-white mb-2">Game Over!</h2>
                <div class="text-6xl font-bold text-orange-500 mb-6 font-mono" id="final-score">0</div>
                
                <div class="grid grid-cols-2 gap-4 text-left mb-6 bg-slate-900/50 p-4 rounded-xl">
                    <div>
                        <div class="text-xs text-slate-400">Hits</div>
                        <div class="font-bold text-green-400" id="final-hits">0</div>
                    </div>
                    <div>
                        <div class="text-xs text-slate-400">Misses</div>
                        <div class="font-bold text-red-400" id="final-misses">0</div>
                    </div>
                    <div>
                        <div class="text-xs text-slate-400">Avg Reaction</div>
                        <div class="font-bold text-blue-400"><span id="final-reaction">0</span>ms</div>
                    </div>
                    <div>
                        <div class="text-xs text-slate-400">Accuracy</div>
                        <div class="font-bold text-purple-400"><span id="final-accuracy">0</span>%</div>
                    </div>
                </div>

                <div class="flex gap-3">
                    <button onclick="game.retry()" class="flex-1 bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 rounded-xl transition">
                        Play Again
                    </button>
                    <button onclick="game.exitToMenu()" class="flex-1 bg-slate-700 hover:bg-slate-600 text-white font-bold py-3 rounded-xl transition">
                        Menu
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        /**
         * Sound Manager (Web Audio API)
         * Generates simple beeps and boops without external files.
         */
        const sfx = {
            ctx: new (window.AudioContext || window.webkitAudioContext)(),
            playTone(freq, type, duration) {
                if(this.ctx.state === 'suspended') this.ctx.resume();
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = type;
                osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
                gain.gain.setValueAtTime(0.1, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + duration);
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                osc.start();
                osc.stop(this.ctx.currentTime + duration);
            },
            hit() { this.playTone(600, 'sine', 0.1); },
            miss() { this.playTone(150, 'sawtooth', 0.2); },
            spawn() { this.playTone(800, 'triangle', 0.05); }
        };

        /**
         * Data Manager
         * Handles localStorage operations.
         */
        const db = {
            getKey: () => 'reflexOrb_users',
            getUsers() {
                const data = localStorage.getItem(this.getKey());
                return data ? JSON.parse(data) : {};
            },
            saveUser(user) {
                const users = this.getUsers();
                users[user.username] = user;
                localStorage.setItem(this.getKey(), JSON.stringify(users));
            },
            getUser(username) {
                return this.getUsers()[username];
            },
            userExists(username) {
                return !!this.getUsers()[username];
            },
            getLeaderboard() {
                const users = this.getUsers();
                return Object.values(users);
            }
        };

        /**
         * User State
         */
        let currentUser = null;

        /**
         * UI Manager
         * Handles DOM updates and view switching.
         */
        const ui = {
            views: ['login', 'dashboard', 'game'],
            
            showView(viewName) {
                this.views.forEach(v => {
                    const el = document.getElementById(`view-${v}`);
                    if (v === viewName) el.classList.remove('hidden-view');
                    else el.classList.add('hidden-view');
                });
            },

            updateProfileUI(user) {
                document.getElementById('profile-name').innerText = user.username;
                document.getElementById('profile-initial').innerText = user.username.charAt(0).toUpperCase();
                
                // Calculate derived stats
                const totalShots = user.stats.totalHits + user.stats.totalMisses;
                const acc = totalShots === 0 ? 0 : Math.round((user.stats.totalHits / totalShots) * 100);
                const avgReaction = user.stats.totalHits === 0 ? 0 : Math.round(user.stats.reactionTimeSum / user.stats.totalHits);

                document.getElementById('stat-hits').innerText = user.stats.totalHits;
                document.getElementById('stat-misses').innerText = user.stats.totalMisses;
                document.getElementById('stat-accuracy').innerText = acc;
                document.getElementById('stat-accuracy-bar').style.width = `${acc}%`;
                document.getElementById('stat-reaction').innerText = avgReaction;
            },

            renderLeaderboard(sortBy) {
                const users = db.getLeaderboard();
                const tbody = document.getElementById('leaderboard-body');
                tbody.innerHTML = '';

                // Style active tab
                document.getElementById('lb-tab-score').className = sortBy === 'score' ? "px-3 py-1 rounded bg-slate-600 text-white" : "px-3 py-1 rounded text-slate-400 hover:text-white";
                document.getElementById('lb-tab-accuracy').className = sortBy === 'accuracy' ? "px-3 py-1 rounded bg-slate-600 text-white" : "px-3 py-1 rounded text-slate-400 hover:text-white";

                // Sorting logic
                users.sort((a, b) => {
                    if (sortBy === 'score') {
                        // Based on total hits for simplicity in this general view
                        return b.stats.totalHits - a.stats.totalHits; 
                    } else {
                        const accA = (a.stats.totalHits + a.stats.totalMisses) === 0 ? 0 : a.stats.totalHits / (a.stats.totalHits + a.stats.totalMisses);
                        const accB = (b.stats.totalHits + b.stats.totalMisses) === 0 ? 0 : b.stats.totalHits / (b.stats.totalHits + b.stats.totalMisses);
                        return accB - accA;
                    }
                });

                users.slice(0, 10).forEach((u, index) => {
                    const total = u.stats.totalHits + u.stats.totalMisses;
                    const acc = total === 0 ? 0 : Math.round((u.stats.totalHits / total) * 100);
                    
                    const row = `
                        <tr class="border-b border-slate-800 hover:bg-slate-800/30 transition">
                            <td class="py-2 pl-2 font-mono text-slate-500">#${index + 1}</td>
                            <td class="py-2 font-medium text-white">${u.username}</td>
                            <td class="py-2 text-right text-orange-400 font-mono">${u.stats.totalHits}</td>
                            <td class="py-2 text-right pr-2 text-blue-400 font-mono">${acc}%</td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            }
        };

        /**
         * Game Engine
         */
        const game = {
            active: false,
            mode: null, // 'free', 10, 30
            timer: 0,
            interval: null,
            spawnTimer: null,
            score: 0,
            hits: 0,
            misses: 0,
            ballSpawnTime: 0,
            currentReactionSum: 0,
            
            elements: {
                area: document.getElementById('game-area'),
                score: document.getElementById('hud-score'),
                timer: document.getElementById('hud-timer'),
                accuracy: document.getElementById('hud-accuracy'),
                mode: document.getElementById('hud-mode'),
                gameOverModal: document.getElementById('modal-gameover')
            },

            init(mode) {
                this.mode = mode;
                this.active = true;
                this.score = 0;
                this.hits = 0;
                this.misses = 0;
                this.currentReactionSum = 0;
                this.elements.area.innerHTML = ''; // Clear board
                this.elements.gameOverModal.classList.add('hidden');
                
                // Setup Timer
                if (mode === 'free') {
                    this.timer = 0;
                    this.elements.timer.innerText = "âˆž";
                    this.elements.mode.innerText = "FREE PLAY";
                } else {
                    this.timer = mode;
                    this.elements.timer.innerText = mode.toFixed(1);
                    this.elements.mode.innerText = `${mode}s SPRINT`;
                }

                this.updateHUD();
                ui.showView('game');
                
                // Listen for clicks on the background (Misses)
                this.elements.area.onmousedown = (e) => {
                    if(e.target === this.elements.area) {
                        this.handleMiss(e.clientX, e.clientY);
                    }
                };

                // Start loops
                this.startGameLoop();
                this.spawnBall();
            },

            startGameLoop() {
                if (this.mode !== 'free') {
                    const startTime = Date.now();
                    const duration = this.mode * 1000;

                    this.interval = setInterval(() => {
                        const elapsed = Date.now() - startTime;
                        const remaining = duration - elapsed;

                        if (remaining <= 0) {
                            this.timer = 0;
                            this.updateHUD();
                            this.stop();
                        } else {
                            this.timer = remaining / 1000;
                            this.updateHUD();
                        }
                    }, 50); // High refresh rate for timer
                }
            },

            spawnBall() {
                if (!this.active) return;

                const ball = document.createElement('div');
                const size = 60; // px
                // Random position logic accounting for padding
                const maxX = this.elements.area.clientWidth - size;
                const maxY = this.elements.area.clientHeight - size;
                
                const x = Math.floor(Math.random() * maxX);
                const y = Math.floor(Math.random() * maxY);

                ball.className = 'orb bg-orange-500';
                ball.style.width = `${size}px`;
                ball.style.height = `${size}px`;
                ball.style.left = `${x}px`;
                ball.style.top = `${y}px`;

                // Unique ID for tracking if needed
                ball.dataset.spawnTime = Date.now();

                // Click Event
                ball.onmousedown = (e) => {
                    e.stopPropagation(); // Prevent hitting background
                    this.handleHit(ball);
                };

                // Auto-disappear mechanic (e.g., if user is too slow, 2 seconds)
                // Note: Standard aim trainers usually wait, but the prompt says "disappear if not clicked".
                const lifeTime = 2000; 
                const timeoutId = setTimeout(() => {
                    if (ball.parentElement) {
                        this.handleTimeout(ball);
                    }
                }, lifeTime);
                
                ball.dataset.timeoutId = timeoutId;

                this.elements.area.appendChild(ball);
                // sfx.spawn(); // Optional, can be noisy
            },

            handleHit(ball) {
                if (!this.active) return;
                
                // Clear timeout so it doesn't count as a miss later
                clearTimeout(ball.dataset.timeoutId);

                // Calculate Stats
                const clickTime = Date.now();
                const spawnTime = parseInt(ball.dataset.spawnTime);
                const reaction = clickTime - spawnTime;
                
                this.hits++;
                this.score += 100; // Base score
                this.score += Math.max(0, 500 - reaction); // Bonus for speed
                this.currentReactionSum += reaction;

                // Visual Feedback
                ball.classList.add('dying');
                ball.style.backgroundColor = '#4ade80'; // Green flash
                ball.style.boxShadow = '0 0 20px #4ade80';

                sfx.hit();

                // Remove from DOM after animation
                setTimeout(() => ball.remove(), 200);

                this.updateHUD();
                this.spawnBall(); // Instant respawn
            },

            handleMiss(x, y) {
                if (!this.active) return;
                this.misses++;
                sfx.miss();
                
                // Visual ripple for miss
                const ripple = document.createElement('div');
                ripple.className = 'absolute rounded-full border-2 border-red-500 opacity-50 pointer-events-none';
                ripple.style.left = (x - 10) + 'px'; // adjust for relative container offset usually, but fixed/fullscreen works here
                ripple.style.top = (y - 10) + 'px'; // approximate centering based on mouse
                ripple.style.width = '20px';
                ripple.style.height = '20px';
                ripple.style.animation = 'popIn 0.2s reverse forwards';
                // Note: Absolute positioning logic for click ripples can be complex with nesting, 
                // but since we are fullscreen and e.clientX is global, we need to map to container. 
                // Simplified: Just flash the screen border red.
                
                this.elements.area.style.boxShadow = 'inset 0 0 50px rgba(239, 68, 68, 0.5)';
                setTimeout(() => this.elements.area.style.boxShadow = 'none', 100);

                this.updateHUD();
            },

            handleTimeout(ball) {
                if (!this.active) return;
                this.misses++;
                sfx.miss();
                
                // Visual fade out
                ball.classList.add('dying');
                ball.style.backgroundColor = '#ef4444'; // Red fade
                
                setTimeout(() => ball.remove(), 200);
                
                this.updateHUD();
                this.spawnBall();
            },

            updateHUD() {
                this.elements.score.innerText = this.score;
                if(this.mode !== 'free') {
                    this.elements.timer.innerText = this.timer.toFixed(1);
                }
                
                const total = this.hits + this.misses;
                const acc = total === 0 ? 100 : Math.round((this.hits / total) * 100);
                this.elements.accuracy.innerText = acc;
            },

            stop(aborted = false) {
                this.active = false;
                // Clear any pending timeouts on balls that are still on screen
                this.elements.area.querySelectorAll('.orb').forEach(ball => {
                    clearTimeout(ball.dataset.timeoutId);
                });

                clearInterval(this.interval);
                this.elements.area.innerHTML = '';
                this.elements.area.onmousedown = null;

                if (aborted) {
                    // Abort: Go straight to dashboard without saving stats
                    ui.showView('dashboard');
                } else {
                    // Game finished (timed mode ran out or user clicked End Session): Save stats and show modal
                    this.showGameOver();
                    this.saveStats();
                }
            },

            showGameOver() {
                const total = this.hits + this.misses;
                const acc = total === 0 ? 0 : Math.round((this.hits / total) * 100);
                const avgReaction = this.hits === 0 ? 0 : Math.round(this.currentReactionSum / this.hits);

                document.getElementById('final-score').innerText = this.score;
                document.getElementById('final-hits').innerText = this.hits;
                document.getElementById('final-misses').innerText = this.misses;
                document.getElementById('final-accuracy').innerText = acc;
                document.getElementById('final-reaction').innerText = avgReaction;

                this.elements.gameOverModal.classList.remove('hidden');
            },

            saveStats() {
                if (!currentUser) return;

                // Update runtime stats object
                currentUser.stats.totalHits += this.hits;
                currentUser.stats.totalMisses += this.misses;
                currentUser.stats.reactionTimeSum += this.currentReactionSum;

                // Save to DB
                db.saveUser(currentUser);
                
                // Refresh UI for next time
                ui.updateProfileUI(currentUser);
                ui.renderLeaderboard('score');
            },

            retry() {
                this.init(this.mode);
            },

            exitToMenu() {
                ui.showView('dashboard');
            }
        };

        /**
         * Auth Logic
         */
        document.getElementById('login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const input = document.getElementById('username-input');
            const errorMsg = document.getElementById('login-error');
            const username = input.value.trim();

            // Validation
            const regex = /^[a-zA-Z0-9]+$/;
            
            if (!username) {
                errorMsg.innerText = "Username cannot be empty.";
                errorMsg.classList.remove('hidden');
                return;
            }
            if (!regex.test(username)) {
                errorMsg.innerText = "Only letters and numbers allowed.";
                errorMsg.classList.remove('hidden');
                return;
            }

            // Check if user exists or create new
            if (db.userExists(username)) {
                currentUser = db.getUser(username);
            } else {
                currentUser = {
                    username: username,
                    stats: {
                        totalHits: 0,
                        totalMisses: 0,
                        reactionTimeSum: 0
                    }
                };
                db.saveUser(currentUser);
            }

            errorMsg.classList.add('hidden');
            input.value = '';
            
            // Go to Dashboard
            ui.updateProfileUI(currentUser);
            ui.renderLeaderboard('score');
            ui.showView('dashboard');
        });

        document.getElementById('logout-btn').addEventListener('click', () => {
            currentUser = null;
            ui.showView('login');
        });

        // Initialize
        ui.showView('login');

        /**
         * Global Event Listener for Keyboard Shortcuts
         * Allows user to press ESC to abort the game session and go back to the menu.
         */
        document.addEventListener('keydown', (e) => {
            // Check if the Escape key was pressed
            if (e.key === 'Escape') {
                // If the game is active, stop it and return to the dashboard (aborted=true)
                if (game.active) {
                    game.stop(true);
                }
            }
        });
    </script>
</body>
</html>
